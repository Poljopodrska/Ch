<!-- Načrtovalec Mesne Proizvodnje - Začasni Modul -->
<div class="legacy-module-container">
    <!-- Opozorilo o začasnem modulu -->
    <div class="legacy-notice">
        <span class="icon-warning">⚠️</span>
        <div>
            <strong>Začasni modul</strong> - Ta modul bo nadomestil integriran sistem Ch za načrtovanje proizvodnje.
            Podatki se shranjujejo lokalno in se morda ne sinhronizirajo z drugimi moduli Ch.
        </div>
    </div>
    
    <!-- Iframe vsebnik -->
    <div class="iframe-container">
        <div class="iframe-loading" id="iframe-loading">
            <div class="spinner"></div>
            <span>Nalaganje načrtovalca mesne proizvodnje...</span>
        </div>
        
        <iframe 
            id="meat-planner-frame"
            src="meat-production-planner/standalone-app.html"
            frameborder="0"
            width="100%"
            height="700px"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
            onload="LegacyMeatPlanner.onIframeLoaded()"
            onerror="LegacyMeatPlanner.onIframeError()">
            <p>Vaš brskalnik ne podpira iframe elementov. Prosimo, posodobite na sodoben brskalnik za uporabo načrtovalca.</p>
        </iframe>
    </div>
    
    <!-- Informacije o migraciji -->
    <div class="migration-info">
        <h4>🚀 Migracija na Ch sistem načrtovanja proizvodnje</h4>
        <p><strong>Trenutni status:</strong> Ta začasni modul omogoča takojšen dostop do načrtovanja mesne proizvodnje, medtem ko razvijamo integrirano rešitev Ch.</p>
        <ul>
            <li><strong>Shranjevanje podatkov:</strong> Uporablja lokalno shranjevanje v brskalniku (podatki ostanejo na vašem računalniku)</li>
            <li><strong>Funkcionalnosti:</strong> Celotno načrtovanje mesne proizvodnje, analiza stroškov in razporejanje delavcev</li>
            <li><strong>Pot migracije:</strong> Podatki bodo migrirani v PostgreSQL, ko bo nov sistem pripravljen</li>
            <li><strong>Časovnica:</strong> Načrtovana zamenjava z nativnim modulom Ch do Q2 2025</li>
        </ul>
    </div>
</div>

<script>
// Legacy Meat Planner Integration
window.LegacyMeatPlanner = {
    onIframeLoaded() {
        console.log('Načrtovalec mesne proizvodnje uspešno naložen');
        
        // Hide loading overlay
        const loadingOverlay = document.getElementById('iframe-loading');
        if (loadingOverlay) {
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 1000);
        }
        
        // Try to establish communication with iframe
        this.setupIframeCommunication();
    },
    
    onIframeError() {
        console.error('Napaka pri nalaganju načrtovalca mesne proizvodnje');
        
        const loadingOverlay = document.getElementById('iframe-loading');
        if (loadingOverlay) {
            loadingOverlay.innerHTML = `
                <span style="color: #d32f2f;">❌</span>
                <span>Napaka pri nalaganju načrtovalca. Prosimo, preverite pot do datoteke.</span>
            `;
        }
    },
    
    setupIframeCommunication() {
        // Listen for messages from the iframe
        window.addEventListener('message', (event) => {
            // Only accept messages from our iframe
            const iframe = document.getElementById('meat-planner-frame');
            if (event.source !== iframe.contentWindow) return;
            
            console.log('Message from Legacy Meat Planner:', event.data);
            
            // Handle different message types
            switch (event.data.type) {
                case 'data_export':
                    this.handleDataExport(event.data.payload);
                    break;
                case 'user_action':
                    this.logUserAction(event.data.payload);
                    break;
                default:
                    console.log('Unknown message type:', event.data.type);
            }
        });
        
        // Send initialization message to iframe
        setTimeout(() => {
            const iframe = document.getElementById('meat-planner-frame');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    type: 'ch_integration_init',
                    source: 'ch_parent',
                    config: {
                        version: '0.1.0',
                        mode: 'legacy_integration'
                    }
                }, '*');
            }
        }, 2000);
    },
    
    handleDataExport(data) {
        console.log('Handling data export from Legacy Meat Planner:', data);
        
        // In future, this could sync data to PostgreSQL
        // For now, just log the action
        if (window.ChApp && window.ChApp.updateStatus) {
            window.ChApp.updateStatus('Legacy data exported');
        }
    },
    
    logUserAction(action) {
        console.log('Legacy Meat Planner user action:', action);
        
        // Track usage for migration planning
        const usageData = JSON.parse(localStorage.getItem('ch_legacy_usage') || '[]');
        usageData.push({
            timestamp: new Date().toISOString(),
            action: action,
            module: 'meat_planner_legacy'
        });
        
        // Keep only last 100 actions
        if (usageData.length > 100) {
            usageData.splice(0, usageData.length - 100);
        }
        
        localStorage.setItem('ch_legacy_usage', JSON.stringify(usageData));
    },
    
    // Method to extract data for migration (can be called from Ch console)
    extractLegacyData() {
        const iframe = document.getElementById('meat-planner-frame');
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({
                type: 'ch_extract_data',
                source: 'ch_parent'
            }, '*');
        }
    },
    
    // Check if legacy module is responsive
    healthCheck() {
        const iframe = document.getElementById('meat-planner-frame');
        if (!iframe) return false;
        
        try {
            // Check if iframe is loaded and responsive
            return iframe.contentDocument !== null;
        } catch (e) {
            console.warn('Legacy module health check failed:', e);
            return false;
        }
    }
};

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Legacy Meat Planner module initialized');
    });
} else {
    console.log('Legacy Meat Planner module initialized');
}
</script>