<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pi≈°ƒçanƒçja Proizvodnja - Pivka (Enhanced)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #c02425 0%, #f0cb35 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .location-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 20px;
            margin: 10px 0;
        }

        .main-content {
            padding: 30px;
        }

        .weather-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .weather-day {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .weather-day.today {
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
        }

        .weather-temp {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }

        .weather-desc {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .weather-icon {
            font-size: 2em;
            margin: 5px 0;
        }


        .shortage-info {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }

        .shortage-info h3 {
            color: #ff6b00;
            margin-bottom: 10px;
        }

        .data-tables {
            margin-bottom: 30px;
        }

        .table-section {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-header {
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .shortage-cell {
            background: #ffebee !important;
            position: relative;
        }

        .shortage-cell::after {
            content: "‚ùå Pomanjkanje";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7em;
            color: #d32f2f;
            font-weight: bold;
        }

        .shortage-checkbox {
            margin-left: 8px;
            cursor: pointer;
            transform: scale(1.2);
            vertical-align: middle;
        }

        .alternative-value {
            color: #1976d2;
            font-style: italic;
            display: block;
            font-size: 0.9em;
        }

        .manual-plan-input {
            width: 80px;
            padding: 5px;
            border: 2px solid #4caf50;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            margin-right: 5px;
        }

        .manual-plan-input:focus {
            outline: none;
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .shortage-marker-btn {
            background: #ff5722;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            margin-left: 5px;
        }

        .shortage-marker-btn.active {
            background: #d32f2f;
        }

        .increase {
            color: #4caf50;
            font-weight: bold;
        }

        .decrease {
            color: #f44336;
            font-weight: bold;
        }

        .ai-reasoning {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .ai-reasoning h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .reasoning-list {
            list-style: none;
            padding: 0;
        }

        .reasoning-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reasoning-icon {
            font-size: 1.5em;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .calculate-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s;
            display: block;
            margin: 30px auto;
        }

        .calculate-btn:hover {
            transform: scale(1.05);
        }

        .total-row {
            font-weight: bold;
            background: #f0f0f0;
        }

        .controls-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }

        .control-btn:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêî AI Pi≈°ƒçanƒçja Proizvodnja - Enhanced</h1>
            <div class="location-badge">üìç Pivka, Slovenija</div>
            <p>Inteligentno naƒçrtovanje z upravljanjem pomanjkanja</p>
        </div>

        <div class="main-content">
            <!-- Weather Section -->
            <div class="weather-section">
                <h2>üå§Ô∏è Vremenska napoved - Pivka (ta teden)</h2>
                <div id="weatherGrid" class="weather-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Pridobivanje vremenskih podatkov...</p>
                    </div>
                </div>
            </div>

            <!-- Shortage Info -->
            <div class="shortage-info">
                <h3>‚ö†Ô∏è Upravljanje pomanjkanja</h3>
                <ul>
                    <li>‚úÖ Oznaƒçite dni, ko ste lani imeli pomanjkanje (rdeƒça polja)</li>
                    <li>üîÑ Sistem bo uporabil alternativne podatke iz podobnih dni</li>
                    <li>üìù Vnesite roƒçni naƒçrt proizvodnje v zelena polja</li>
                    <li>‚ùå Oznaƒçite trenutna pomanjkanja s klikom na gumb "Pomanjkanje"</li>
                </ul>
            </div>

            <!-- Historical Data with Shortage Marking -->
            <div class="table-section">
                <div class="table-header">
                    üìä Zgodovinski podatki (lani ta teden)
                    <span style="float: right; font-size: 0.8em; font-weight: normal;">
                        ‚òëÔ∏è Oznaƒçite dni s pomanjkanjem
                    </span>
                </div>
                <div class="controls-row">
                    <div>
                        <button class="control-btn" onclick="clearAllShortages()">üîÑ Poƒçisti oznaƒçbe</button>
                        <button class="control-btn" onclick="markTestShortages()">üìù Testni podatki</button>
                    </div>
                    <div style="font-size: 0.9em;">
                        Kliknite na celice za oznaƒçitev pomanjkanja
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Pon</th>
                            <th>Tor</th>
                            <th>Sre</th>
                            <th>ƒået</th>
                            <th>Pet</th>
                            <th>Sob</th>
                            <th>Ned</th>
                            <th>Skupaj</th>
                        </tr>
                    </thead>
                    <tbody id="historicalData">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Manual Planning Table -->
            <div class="table-section">
                <div class="table-header">
                    üìù Roƒçni naƒçrt proizvodnje (vnesite koliƒçine)
                    <span style="float: right; font-size: 0.8em; font-weight: normal;">
                        ‚úèÔ∏è Vnesite naƒçrtovane koliƒçine
                    </span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Pon</th>
                            <th>Tor</th>
                            <th>Sre</th>
                            <th>ƒået</th>
                            <th>Pet</th>
                            <th>Sob</th>
                            <th>Ned</th>
                            <th>Skupaj</th>
                        </tr>
                    </thead>
                    <tbody id="manualPlanData">
                        <!-- Manual input fields will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- AI Adjusted Data -->
            <div class="table-section">
                <div class="table-header">
                    ü§ñ AI Prilagojena napoved (ta teden)
                    <span style="float: right; font-size: 0.8em; font-weight: normal;">
                        üéØ Oznaƒçite trenutna pomanjkanja
                    </span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Pon</th>
                            <th>Tor</th>
                            <th>Sre</th>
                            <th>ƒået</th>
                            <th>Pet</th>
                            <th>Sob</th>
                            <th>Ned</th>
                            <th>Skupaj</th>
                        </tr>
                    </thead>
                    <tbody id="aiAdjustedData">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <button class="calculate-btn" onclick="calculateAIForecast()">
                                    üöÄ Generiraj AI napoved
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- AI Reasoning Section -->
            <div class="ai-reasoning" id="aiReasoning" style="display: none;">
                <h3>üß† AI Razlogi za prilagoditve:</h3>
                <ul class="reasoning-list" id="reasoningList">
                </ul>
            </div>

            <!-- Chart Section -->
            <div class="chart-container" id="chartContainer" style="display: none;">
                <h3 style="text-align: center; margin-bottom: 20px;">üìà Primerjava: Zgodovinski vs Roƒçni naƒçrt vs AI Napoved</h3>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const PIVKA_LAT = 45.6839;
        const PIVKA_LON = 14.1945;
        const USE_SIMULATED_DATA = true;

        let weatherData = null;
        let comparisonChart = null;
        let shortageMap = {};
        let currentShortages = {};
        let manualPlan = {};

        // Days of week in Slovenian
        const daysOfWeek = ['Ned', 'Pon', 'Tor', 'Sre', 'ƒået', 'Pet', 'Sob'];
        const dayColumns = ['pon', 'tor', 'sre', 'cet', 'pet', 'sob', 'ned'];
        const fullDays = ['Nedelja', 'Ponedeljek', 'Torek', 'Sreda', 'ƒåetrtek', 'Petek', 'Sobota'];

        // Weather icons mapping
        const weatherIcons = {
            'Clear': '‚òÄÔ∏è',
            'Clouds': '‚òÅÔ∏è',
            'Rain': 'üåßÔ∏è',
            'Drizzle': 'üå¶Ô∏è',
            'Thunderstorm': '‚õàÔ∏è',
            'Snow': '‚ùÑÔ∏è',
            'Mist': 'üå´Ô∏è',
            'Fog': 'üå´Ô∏è'
        };

        // Historical data
        const historicalData = {
            'Bedra': [850, 920, 980, 1100, 1350, 1600, 1200],
            'File prsi': [1200, 1250, 1300, 1400, 1650, 1900, 1500],
            'Krila': [600, 650, 700, 750, 950, 1200, 900],
            'Ra≈ænjiƒçi': [400, 420, 450, 500, 650, 800, 600]
        };

        // Alternative data for shortage compensation (from 2 weeks ago)
        const alternativeData = {
            'Bedra': [880, 950, 1000, 1150, 1400, 1650, 1250],
            'File prsi': [1250, 1300, 1350, 1450, 1700, 1950, 1550],
            'Krila': [620, 680, 720, 780, 980, 1250, 930],
            'Ra≈ænjiƒçi': [420, 440, 470, 520, 680, 830, 620]
        };

        // Load weather data on page load
        window.addEventListener('load', function() {
            loadWeatherData();
            initializeHistoricalTable();
            initializeManualPlanTable();
        });

        function initializeHistoricalTable() {
            const tbody = document.getElementById('historicalData');
            let html = '';

            Object.keys(historicalData).forEach(product => {
                html += '<tr>';
                html += `<td><strong>${product}</strong></td>`;

                let total = 0;
                historicalData[product].forEach((value, dayIndex) => {
                    const cellId = `hist-${product.toLowerCase().replace(' ', '-')}-${dayIndex}`;
                    total += value;
                    html += `<td id="${cellId}" onclick="toggleShortage('${product}', ${dayIndex}, '${cellId}')" style="cursor: pointer;">
                        <span class="original-value">${value}</span>
                    </td>`;
                });

                html += `<td><strong>${total}</strong></td>`;
                html += '</tr>';
            });

            const totals = historicalData['Bedra'].map((_, i) =>
                Object.values(historicalData).reduce((sum, product) => sum + product[i], 0)
            );
            const grandTotal = totals.reduce((a, b) => a + b, 0);

            html += '<tr class="total-row">';
            html += '<td><strong>SKUPAJ</strong></td>';
            totals.forEach(total => {
                html += `<td>${total}</td>`;
            });
            html += `<td><strong>${grandTotal}</strong></td>`;
            html += '</tr>';

            tbody.innerHTML = html;
        }

        function initializeManualPlanTable() {
            const tbody = document.getElementById('manualPlanData');
            let html = '';

            Object.keys(historicalData).forEach(product => {
                html += '<tr>';
                html += `<td><strong>${product}</strong></td>`;

                historicalData[product].forEach((value, dayIndex) => {
                    const inputId = `plan-${product.toLowerCase().replace(' ', '-')}-${dayIndex}`;
                    html += `<td>
                        <input type="number"
                               id="${inputId}"
                               class="manual-plan-input"
                               placeholder="${value}"
                               onchange="updateManualPlan('${product}', ${dayIndex}, this.value)">
                    </td>`;
                });

                html += `<td id="plan-total-${product.toLowerCase().replace(' ', '-')}"><strong>-</strong></td>`;
                html += '</tr>';
            });

            html += '<tr class="total-row">';
            html += '<td><strong>SKUPAJ</strong></td>';
            dayColumns.forEach((_, index) => {
                html += `<td id="plan-day-total-${index}">-</td>`;
            });
            html += `<td id="plan-grand-total"><strong>-</strong></td>`;
            html += '</tr>';

            tbody.innerHTML = html;
        }

        function toggleShortage(product, dayIndex, cellId) {
            const key = `${product}-${dayIndex}`;
            const cell = document.getElementById(cellId);

            if (shortageMap[key]) {
                // Remove shortage
                delete shortageMap[key];
                cell.classList.remove('shortage-cell');
                cell.innerHTML = `<span class="original-value">${historicalData[product][dayIndex]}</span>`;
            } else {
                // Add shortage
                shortageMap[key] = true;
                cell.classList.add('shortage-cell');
                const altValue = alternativeData[product][dayIndex];
                cell.innerHTML = `
                    <span class="original-value" style="text-decoration: line-through; color: #999;">${historicalData[product][dayIndex]}</span>
                    <span class="alternative-value">‚Üí ${altValue}</span>
                `;
            }
        }

        function updateManualPlan(product, dayIndex, value) {
            const key = `${product}-${dayIndex}`;
            if (value && value > 0) {
                manualPlan[key] = parseInt(value);
            } else {
                delete manualPlan[key];
            }
            updateManualPlanTotals();
        }

        function updateManualPlanTotals() {
            // Update product totals
            Object.keys(historicalData).forEach(product => {
                let total = 0;
                for (let i = 0; i < 7; i++) {
                    const key = `${product}-${i}`;
                    total += manualPlan[key] || 0;
                }
                const totalCell = document.getElementById(`plan-total-${product.toLowerCase().replace(' ', '-')}`);
                if (totalCell) {
                    totalCell.innerHTML = total > 0 ? `<strong>${total}</strong>` : '<strong>-</strong>';
                }
            });

            // Update day totals
            for (let i = 0; i < 7; i++) {
                let dayTotal = 0;
                Object.keys(historicalData).forEach(product => {
                    const key = `${product}-${i}`;
                    dayTotal += manualPlan[key] || 0;
                });
                const dayTotalCell = document.getElementById(`plan-day-total-${i}`);
                if (dayTotalCell) {
                    dayTotalCell.textContent = dayTotal > 0 ? dayTotal : '-';
                }
            }

            // Update grand total
            let grandTotal = 0;
            Object.values(manualPlan).forEach(value => {
                grandTotal += value;
            });
            const grandTotalCell = document.getElementById('plan-grand-total');
            if (grandTotalCell) {
                grandTotalCell.innerHTML = grandTotal > 0 ? `<strong>${grandTotal}</strong>` : '<strong>-</strong>';
            }
        }

        function clearAllShortages() {
            shortageMap = {};
            currentShortages = {};
            initializeHistoricalTable();

            // Clear AI adjusted table current shortages
            const buttons = document.querySelectorAll('.shortage-marker-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
        }

        function markTestShortages() {
            // Mark some test shortages for demonstration
            shortageMap = {
                'Bedra-2': true,  // Wednesday
                'File prsi-4': true,  // Friday
                'Krila-5': true,  // Saturday
                'Ra≈ænjiƒçi-1': true  // Tuesday
            };

            // Refresh the table to show shortages
            initializeHistoricalTable();

            // Apply shortage styling
            Object.keys(shortageMap).forEach(key => {
                const [product, dayIndex] = key.split('-');
                const cellId = `hist-${product.toLowerCase().replace(' ', '-')}-${dayIndex}`;
                toggleShortage(product, parseInt(dayIndex), cellId);
            });
        }

        function toggleCurrentShortage(product, dayIndex, btnId) {
            const key = `${product}-${dayIndex}`;
            const btn = document.getElementById(btnId);

            if (currentShortages[key]) {
                delete currentShortages[key];
                btn.classList.remove('active');
                btn.textContent = 'Pomanjkanje';
            } else {
                currentShortages[key] = true;
                btn.classList.add('active');
                btn.textContent = '‚ùå Pomanjkanje';
            }
        }

        async function loadWeatherData() {
            if (USE_SIMULATED_DATA) {
                weatherData = generateSimulatedWeatherData();
                displayWeather(weatherData);
            } else {
                document.getElementById('weatherGrid').innerHTML =
                    '<p style="color: white;">Weather API configuration needed</p>';
            }
        }

        function generateSimulatedWeatherData() {
            const today = new Date();
            const weatherPatterns = [
                { weather: 'Clear', description: 'jasno', temp: 24, minTemp: 15, maxTemp: 28, rain: 0, windSpeed: 2.5 },
                { weather: 'Clouds', description: 'delno oblaƒçno', temp: 22, minTemp: 14, maxTemp: 26, rain: 0, windSpeed: 3.1 },
                { weather: 'Rain', description: 'rahel de≈æ', temp: 18, minTemp: 12, maxTemp: 21, rain: 3.5, windSpeed: 4.2 },
                { weather: 'Clouds', description: 'oblaƒçno', temp: 19, minTemp: 13, maxTemp: 23, rain: 0, windSpeed: 2.8 },
                { weather: 'Clear', description: 'sonƒçno', temp: 25, minTemp: 16, maxTemp: 29, rain: 0, windSpeed: 2.2 },
                { weather: 'Clear', description: 'jasno', temp: 27, minTemp: 17, maxTemp: 31, rain: 0, windSpeed: 1.9 },
                { weather: 'Clouds', description: 'delno oblaƒçno', temp: 26, minTemp: 16, maxTemp: 30, rain: 0, windSpeed: 2.4 }
            ];

            return weatherPatterns.map((pattern, index) => {
                const date = new Date(today);
                date.setDate(today.getDate() + index);
                return {
                    date: date,
                    ...pattern
                };
            });
        }

        function displayWeather(weatherData) {
            const grid = document.getElementById('weatherGrid');
            const today = new Date().toDateString();

            let html = '';
            weatherData.forEach((day, index) => {
                const isToday = day.date.toDateString() === today;
                const dayName = fullDays[day.date.getDay()];
                const icon = weatherIcons[day.weather] || 'üå§Ô∏è';

                html += `
                    <div class="weather-day ${isToday ? 'today' : ''}">
                        <div><strong>${dayName}</strong></div>
                        <div>${day.date.getDate()}.${day.date.getMonth() + 1}.</div>
                        <div class="weather-icon">${icon}</div>
                        <div class="weather-temp">${day.maxTemp}¬∞</div>
                        <div style="font-size: 0.9em;">Min: ${day.minTemp}¬∞</div>
                        <div class="weather-desc">${day.description}</div>
                        ${day.rain > 0 ? `<div>üíß ${day.rain}mm</div>` : ''}
                        <div>üí® ${day.windSpeed}m/s</div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        async function calculateAIForecast() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Generiram napoved...';

            // Prepare weather summary for AI
            const weatherSummary = weatherData.map(d => ({
                day: fullDays[d.date.getDay()],
                temp: d.temp,
                weather: d.weather,
                rain: d.rain
            }));

            // Generate AI reasoning including shortage handling
            const aiReasonings = generateAIReasoning(weatherSummary);
            const adjustedData = calculateAdjustments(weatherSummary);

            // Display results
            displayAdjustedData(adjustedData);
            displayAIReasoning(aiReasonings);
            displayComparisonChart(adjustedData);

            button.textContent = 'üöÄ Generiraj AI napoved';
            button.disabled = false;
        }

        function generateAIReasoning(weatherSummary) {
            const reasonings = [];

            // Shortage compensation reasoning
            const shortageCount = Object.keys(shortageMap).length;
            if (shortageCount > 0) {
                reasonings.push({
                    icon: 'üîÑ',
                    text: `Zaznal sem ${shortageCount} dni s pomanjkanjem lani - uporabljam alternativne podatke iz prej≈°njih tednov`
                });
            }

            // Manual plan reasoning
            const manualCount = Object.keys(manualPlan).length;
            if (manualCount > 0) {
                reasonings.push({
                    icon: 'üìù',
                    text: `Upo≈°tevam ${manualCount} roƒçno naƒçrtovanih vrednosti v proizvodnem planu`
                });
            }

            // Weather-based reasoning
            const rainyDays = weatherSummary.filter(d => parseFloat(d.rain) > 0);
            if (rainyDays.length > 0) {
                reasonings.push({
                    icon: 'üåßÔ∏è',
                    text: `De≈æ napovedan za ${rainyDays.length} dni - prilagajam proizvodnjo za notranje obroke`
                });
            }

            const hotDays = weatherSummary.filter(d => d.temp > 25);
            if (hotDays.length > 0) {
                reasonings.push({
                    icon: '‚òÄÔ∏è',
                    text: `Toplo vreme (${hotDays.length} dni nad 25¬∞C) - poveƒçana proizvodnja za ≈æar produkte`
                });
            }

            // Weekend reasoning
            reasonings.push({
                icon: 'üìÖ',
                text: 'Vikend efekt: +40% sobota, +25% nedelja za piknik produkte'
            });

            // Shortage prevention
            if (Object.keys(currentShortages).length > 0) {
                reasonings.push({
                    icon: '‚ö†Ô∏è',
                    text: `Trenutna pomanjkanja zaznana - predlagam poveƒçanje varnostnih zalog`
                });
            }

            return reasonings;
        }

        function calculateAdjustments(weatherSummary) {
            const adjustedData = {};

            Object.keys(historicalData).forEach(product => {
                adjustedData[product] = [];

                historicalData[product].forEach((baseValue, dayIndex) => {
                    let adjustedValue = baseValue;

                    // Check for shortage compensation
                    const shortageKey = `${product}-${dayIndex}`;
                    if (shortageMap[shortageKey]) {
                        // Use alternative data if shortage was marked
                        adjustedValue = alternativeData[product][dayIndex];
                    }

                    // Check for manual plan override
                    if (manualPlan[shortageKey] && manualPlan[shortageKey] > 0) {
                        adjustedValue = manualPlan[shortageKey];
                    } else {
                        // Apply weather and other adjustments only if not manually planned
                        const weather = weatherSummary[dayIndex];

                        if (weather) {
                            if (parseFloat(weather.rain) > 0) {
                                if (product === 'Ra≈ænjiƒçi' || product === 'Krila') {
                                    adjustedValue *= 0.9;
                                }
                            }

                            if (weather.temp > 25) {
                                if (product === 'Ra≈ænjiƒçi') {
                                    adjustedValue *= 1.2;
                                } else if (product === 'Krila') {
                                    adjustedValue *= 1.15;
                                }
                            }
                        }

                        // Day of week adjustments
                        const actualDay = (dayIndex + 1) % 7;
                        if (actualDay === 6) { // Saturday
                            adjustedValue *= 1.4;
                        } else if (actualDay === 0) { // Sunday
                            adjustedValue *= 1.25;
                        } else if (actualDay === 5) { // Friday
                            adjustedValue *= 1.15;
                        }

                        // Add safety buffer if current shortage exists
                        if (currentShortages[shortageKey]) {
                            adjustedValue *= 1.2;
                        }
                    }

                    adjustedData[product].push(Math.round(adjustedValue));
                });
            });

            return adjustedData;
        }

        function displayAdjustedData(adjustedData) {
            const tbody = document.getElementById('aiAdjustedData');
            let html = '';
            let dailyTotals = [0, 0, 0, 0, 0, 0, 0];

            Object.keys(adjustedData).forEach(product => {
                html += '<tr>';
                html += `<td><strong>${product}</strong></td>`;

                let productTotal = 0;
                adjustedData[product].forEach((value, index) => {
                    const shortageKey = `${product}-${index}`;
                    const btnId = `shortage-btn-${product.toLowerCase().replace(' ', '-')}-${index}`;

                    let baseValue = historicalData[product][index];
                    if (shortageMap[shortageKey]) {
                        baseValue = alternativeData[product][index];
                    }

                    const change = ((value - baseValue) / baseValue * 100).toFixed(0);
                    const changeClass = value > baseValue ? 'increase' : value < baseValue ? 'decrease' : '';

                    html += `<td>
                        ${value}
                        ${Math.abs(change) > 5 ? `<span class="${changeClass}">(${change > 0 ? '+' : ''}${change}%)</span>` : ''}
                        <button id="${btnId}"
                                class="shortage-marker-btn ${currentShortages[shortageKey] ? 'active' : ''}"
                                onclick="toggleCurrentShortage('${product}', ${index}, '${btnId}')">
                            ${currentShortages[shortageKey] ? '‚ùå Pomanjkanje' : 'Pomanjkanje'}
                        </button>
                    </td>`;

                    productTotal += value;
                    dailyTotals[index] += value;
                });

                html += `<td><strong>${productTotal}</strong></td>`;
                html += '</tr>';
            });

            // Total row
            html += '<tr class="total-row">';
            html += '<td><strong>SKUPAJ</strong></td>';
            let grandTotal = 0;
            dailyTotals.forEach(total => {
                html += `<td>${total}</td>`;
                grandTotal += total;
            });
            html += `<td><strong>${grandTotal}</strong></td>`;
            html += '</tr>';

            tbody.innerHTML = html;
        }

        function displayAIReasoning(reasonings) {
            const section = document.getElementById('aiReasoning');
            const list = document.getElementById('reasoningList');

            let html = '';
            reasonings.forEach(reasoning => {
                html += `
                    <li class="reasoning-item">
                        <span class="reasoning-icon">${reasoning.icon}</span>
                        <span>${reasoning.text}</span>
                    </li>
                `;
            });

            list.innerHTML = html;
            section.style.display = 'block';
        }

        function displayComparisonChart(adjustedData) {
            const container = document.getElementById('chartContainer');
            container.style.display = 'block';

            if (comparisonChart) {
                comparisonChart.destroy();
            }

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const labels = ['Ponedeljek', 'Torek', 'Sreda', 'ƒåetrtek', 'Petek', 'Sobota', 'Nedelja'];

            const datasets = [];
            const colors = {
                'Bedra': { border: '#ff6384', bg: 'rgba(255, 99, 132, 0.2)' },
                'File prsi': { border: '#36a2eb', bg: 'rgba(54, 162, 235, 0.2)' },
                'Krila': { border: '#ffcd56', bg: 'rgba(255, 205, 86, 0.2)' },
                'Ra≈ænjiƒçi': { border: '#4bc0c0', bg: 'rgba(75, 192, 192, 0.2)' }
            };

            // Add datasets for each product
            Object.keys(adjustedData).forEach(product => {
                // AI forecast
                datasets.push({
                    label: product + ' (AI napoved)',
                    data: adjustedData[product],
                    borderColor: colors[product].border,
                    backgroundColor: colors[product].bg,
                    borderWidth: 3,
                    tension: 0.4
                });

                // Manual plan (if exists)
                const manualData = [];
                for (let i = 0; i < 7; i++) {
                    const key = `${product}-${i}`;
                    manualData.push(manualPlan[key] || null);
                }

                if (manualData.some(v => v !== null)) {
                    datasets.push({
                        label: product + ' (Roƒçni naƒçrt)',
                        data: manualData,
                        borderColor: colors[product].border,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        tension: 0.4
                    });
                }
            });

            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Koliƒçina (kg)'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>