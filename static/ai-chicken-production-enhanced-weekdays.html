<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pi≈°ƒçanƒçja Proizvodnja - Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #c02425 0%, #f0cb35 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            padding: 30px;
        }

        /* Product selector */
        .product-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .product-dropdown {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-dropdown label {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .product-dropdown select {
            padding: 10px 20px;
            font-size: 1.1em;
            border: 2px solid #2196f3;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .product-dropdown select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow-x: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .data-table th.row-header {
            text-align: left;
            padding-left: 20px;
            min-width: 180px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #f5f5f5;
            text-align: center;
        }

        .data-table td.row-header {
            text-align: left;
            padding-left: 20px;
            font-weight: 600;
            background: #f8f9fa;
        }

        /* Weather row */
        .weather-row {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .weather-cell {
            padding: 15px !important;
        }

        .weather-icon {
            font-size: 2.5em;
            display: block;
        }

        .weather-temp {
            font-size: 1.4em;
            font-weight: bold;
            color: #1976d2;
            margin: 5px 0;
        }

        .weather-desc {
            font-size: 0.9em;
            color: #555;
        }

        /* Section headers */
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            padding: 12px !important;
        }

        .historical-row {
            background: #fff;
        }

        .ai-row {
            background: #fff3e0;
        }

        .actual-row {
            background: #e8f5e9;
        }

        /* Shortage checkbox */
        .shortage-checkbox {
            margin-left: 8px;
            cursor: pointer;
            transform: scale(1.3);
            vertical-align: middle;
        }

        .shortage-label {
            font-size: 0.8em;
            color: #f44336;
            display: block;
            margin-top: 5px;
        }

        .alternative-data {
            display: inline-block;
            padding: 3px 6px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
            color: #856404;
        }

        /* Input fields */
        .actual-input {
            width: 90px;
            padding: 8px;
            border: 2px solid #4caf50;
            border-radius: 6px;
            font-size: 1em;
            text-align: center;
        }

        .actual-input:focus {
            outline: none;
            border-color: #2196f3;
            background: #e3f2fd;
        }

        /* Totals */
        .total-row {
            background: #eceff1;
            font-weight: bold;
        }

        /* Chart */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: 300px;
        }

        .chart-title {
            text-align: center;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Calculate button */
        .calculate-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .calculate-btn:hover {
            transform: scale(1.05);
        }

        /* Value indicators */
        .increase {
            color: #4caf50;
            font-weight: bold;
            font-size: 0.85em;
        }

        .decrease {
            color: #f44336;
            font-weight: bold;
            font-size: 0.85em;
        }

        /* Reason indicators */
        .reason-cell {
            background: #f5f5f5;
            padding: 10px !important;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .reason-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            margin: 2px;
            font-weight: bold;
            white-space: nowrap;
        }

        .reason-up {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .reason-down {
            background: #ffcdd2;
            color: #c62828;
        }

        .reason-neutral {
            background: #e0e0e0;
            color: #424242;
        }

        /* Product name display */
        .current-product {
            font-size: 1.2em;
            color: #1976d2;
            font-weight: bold;
            padding: 10px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            display: inline-block;
        }

        /* Loading spinner */
        .loading-weather {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #1976d2;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .current-shortage-row {
            background: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêî AI Pi≈°ƒçanƒçja Proizvodnja</h1>
            <p>Pivka, Slovenija - Delovni dnevi (Pon-Pet)</p>
        </div>

        <div class="main-content">
            <!-- Product Selector -->
            <div class="product-selector">
                <div class="product-dropdown">
                    <label for="productSelect">Izberi produkt:</label>
                    <select id="productSelect" onchange="changeProduct()">
                        <option value="Bedra">üçó Bedra</option>
                        <option value="File prsi">ü•© File prsi</option>
                        <option value="Krila">üçñ Krila</option>
                        <option value="Ra≈ænjiƒçi">üç¢ Ra≈ænjiƒçi</option>
                    </select>
                </div>
                <button class="calculate-btn" onclick="generateAIPrognosis()">
                    ü§ñ Generiraj AI prognozo
                </button>
            </div>

            <!-- Main Data Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="row-header">
                                <span class="current-product" id="currentProductDisplay">üçó Bedra</span>
                            </th>
                            <th>Ponedeljek<br><span style="font-size: 0.8em" id="date-0"></span></th>
                            <th>Torek<br><span style="font-size: 0.8em" id="date-1"></span></th>
                            <th>Sreda<br><span style="font-size: 0.8em" id="date-2"></span></th>
                            <th>ƒåetrtek<br><span style="font-size: 0.8em" id="date-3"></span></th>
                            <th>Petek<br><span style="font-size: 0.8em" id="date-4"></span></th>
                            <th>SKUPAJ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Weather Row -->
                        <tr class="weather-row">
                            <td class="row-header section-header" style="color: black; font-weight: bold;">VREME</td>
                            <td class="weather-cell" id="weather-0">
                                <span class="loading-weather"></span>
                            </td>
                            <td class="weather-cell" id="weather-1">
                                <span class="loading-weather"></span>
                            </td>
                            <td class="weather-cell" id="weather-2">
                                <span class="loading-weather"></span>
                            </td>
                            <td class="weather-cell" id="weather-3">
                                <span class="loading-weather"></span>
                            </td>
                            <td class="weather-cell" id="weather-4">
                                <span class="loading-weather"></span>
                            </td>
                            <td style="background: #e3f2fd;">-</td>
                        </tr>

                        <!-- Last Year Sales -->
                        <tr>
                            <td class="row-header section-header" style="color: black; font-weight: bold;">LANI</td>
                            <td id="hist-0">850<br><input type="checkbox" class="shortage-checkbox" id="shortage-last-0" onchange="markShortage('last', 0)"><label class="shortage-label">pomanjkanje</label></td>
                            <td id="hist-1">920<br><input type="checkbox" class="shortage-checkbox" id="shortage-last-1" onchange="markShortage('last', 1)"><label class="shortage-label">pomanjkanje</label></td>
                            <td id="hist-2">980<br><input type="checkbox" class="shortage-checkbox" id="shortage-last-2" onchange="markShortage('last', 2)"><label class="shortage-label">pomanjkanje</label></td>
                            <td id="hist-3">1100<br><input type="checkbox" class="shortage-checkbox" id="shortage-last-3" onchange="markShortage('last', 3)"><label class="shortage-label">pomanjkanje</label></td>
                            <td id="hist-4">1350<br><input type="checkbox" class="shortage-checkbox" id="shortage-last-4" onchange="markShortage('last', 4)"><label class="shortage-label">pomanjkanje</label></td>
                            <td id="hist-total" class="total-row">4950</td>
                        </tr>

                        <!-- AI Prognosis Section -->
                        <tr id="ai-header" style="display: none;">
                            <td class="row-header section-header" style="color: black; font-weight: bold;">AI PROGNOZA</td>
                            <td id="ai-0">-</td>
                            <td id="ai-1">-</td>
                            <td id="ai-2">-</td>
                            <td id="ai-3">-</td>
                            <td id="ai-4">-</td>
                            <td id="ai-total" class="total-row">-</td>
                        </tr>
                        <tr id="ai-reasons" style="display: none;">
                            <td class="row-header" style="background: #e8eaf6; color: black; font-weight: bold;">Razlogi</td>
                            <td id="reason-0" class="reason-cell">-</td>
                            <td id="reason-1" class="reason-cell">-</td>
                            <td id="reason-2" class="reason-cell">-</td>
                            <td id="reason-3" class="reason-cell">-</td>
                            <td id="reason-4" class="reason-cell">-</td>
                            <td style="background: #f5f5f5;">-</td>
                        </tr>

                        <!-- Actual Sales Input -->
                        <tr>
                            <td class="row-header section-header" style="color: black; font-weight: bold;">DEJANSKA PRODAJA</td>
                            <td><input type="number" class="actual-input" id="actual-0" onchange="updateActuals()"></td>
                            <td><input type="number" class="actual-input" id="actual-1" onchange="updateActuals()"></td>
                            <td><input type="number" class="actual-input" id="actual-2" onchange="updateActuals()"></td>
                            <td><input type="number" class="actual-input" id="actual-3" onchange="updateActuals()"></td>
                            <td><input type="number" class="actual-input" id="actual-4" onchange="updateActuals()"></td>
                            <td id="actual-total" class="total-row">-</td>
                        </tr>

                        <!-- Current Year Shortage -->
                        <tr class="current-shortage-row">
                            <td class="row-header" style="background: #ffcdd2; color: black; font-weight: bold;">Pomanjkanje letos</td>
                            <td><input type="checkbox" class="shortage-checkbox" id="shortage-current-0" onchange="markShortage('current', 0)"></td>
                            <td><input type="checkbox" class="shortage-checkbox" id="shortage-current-1" onchange="markShortage('current', 1)"></td>
                            <td><input type="checkbox" class="shortage-checkbox" id="shortage-current-2" onchange="markShortage('current', 2)"></td>
                            <td><input type="checkbox" class="shortage-checkbox" id="shortage-current-3" onchange="markShortage('current', 3)"></td>
                            <td><input type="checkbox" class="shortage-checkbox" id="shortage-current-4" onchange="markShortage('current', 4)"></td>
                            <td style="background: #ffebee;">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <div class="chart-title">Primerjava: <span id="chartProductName">Bedra</span></div>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Using real API key from ava-olo-constitutional
        const OPENWEATHER_API_KEY = 'f1cc1e5b670d617592f00c3f37fd9db0';
        const PIVKA_LAT = 45.6839;
        const PIVKA_LON = 14.1945;

        // Data storage
        let currentProduct = 'Bedra';
        let lastYearShortageMap = {};
        let currentYearShortageMap = {};
        let aiPrognosis = [];
        let actualSales = [];
        let realWeatherData = [];

        const productEmojis = {
            'Bedra': 'üçó',
            'File prsi': 'ü•©',
            'Krila': 'üçñ',
            'Ra≈ænjiƒçi': 'üç¢'
        };

        // Historical data (Monday-Friday only)
        const historicalData = {
            'Bedra': [850, 920, 980, 1100, 1350],
            'File prsi': [1200, 1250, 1300, 1400, 1650],
            'Krila': [600, 650, 700, 750, 950],
            'Ra≈ænjiƒçi': [400, 420, 450, 500, 650]
        };

        // Alternative data sources (from 2 weeks ago)
        const alternativeData = {
            'Bedra': {
                'pon-2w': 870,
                'tor-2w': 940,
                'sre-2w': 1000,
                'ƒçet-2w': 1120,
                'pet-2w': 1380
            },
            'File prsi': {
                'pon-2w': 1230,
                'tor-2w': 1280,
                'sre-2w': 1320,
                'ƒçet-2w': 1430,
                'pet-2w': 1680
            },
            'Krila': {
                'pon-2w': 615,
                'tor-2w': 665,
                'sre-2w': 715,
                'ƒçet-2w': 770,
                'pet-2w': 970
            },
            'Ra≈ænjiƒçi': {
                'pon-2w': 410,
                'tor-2w': 430,
                'sre-2w': 465,
                'ƒçet-2w': 515,
                'pet-2w': 670
            }
        };

        const dayNames = ['pon-2w', 'tor-2w', 'sre-2w', 'ƒçet-2w', 'pet-2w'];

        let chart = null;

        // Weather icons mapping
        const weatherIcons = {
            'Clear': '‚òÄÔ∏è',
            'Clouds': '‚òÅÔ∏è',
            'Rain': 'üåßÔ∏è',
            'Drizzle': 'üå¶Ô∏è',
            'Thunderstorm': '‚õàÔ∏è',
            'Snow': '‚ùÑÔ∏è',
            'Mist': 'üå´Ô∏è',
            'Fog': 'üå´Ô∏è'
        };

        // Initialize on load
        window.addEventListener('load', function() {
            setupDates();
            loadRealWeatherData();
            initializeChart();
            updateDisplay();
            // Set initial mock shortages for demo
            setTimeout(setDemoShortages, 1000);
        });

        function setupDates() {
            const today = new Date();
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = `${date.getDate()}.${date.getMonth() + 1}.`;
                document.getElementById(`date-${i}`).textContent = dateStr;
            }
        }

        async function loadRealWeatherData() {
            try {
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${PIVKA_LAT}&lon=${PIVKA_LON}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=sl`
                );
                const data = await response.json();

                // Process weather data for next 5 days
                realWeatherData = [];
                const dailyData = {};

                data.list.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const dayKey = date.toDateString();

                    if (!dailyData[dayKey]) {
                        dailyData[dayKey] = {
                            temps: [],
                            weather: item.weather[0].main,
                            description: item.weather[0].description,
                            rain: 0
                        };
                    }

                    dailyData[dayKey].temps.push(item.main.temp);
                    if (item.rain && item.rain['3h']) {
                        dailyData[dayKey].rain += item.rain['3h'];
                    }
                });

                // Get first 5 days
                Object.values(dailyData).slice(0, 5).forEach(day => {
                    realWeatherData.push({
                        temp: Math.round(Math.max(...day.temps)),
                        minTemp: Math.round(Math.min(...day.temps)),
                        weather: day.weather,
                        description: day.description,
                        rain: day.rain
                    });
                });

                displayWeather();
            } catch (error) {
                console.error('Weather API error:', error);
                // Fallback to mock data
                useMockWeatherData();
            }
        }

        function useMockWeatherData() {
            // More realistic mock data for demonstration
            realWeatherData = [
                { temp: 15, minTemp: 8, weather: 'Clouds', description: 'oblaƒçno', rain: 0 },
                { temp: 14, minTemp: 9, weather: 'Rain', description: 'de≈æevno', rain: 3.5 },
                { temp: 18, minTemp: 10, weather: 'Clear', description: 'jasno', rain: 0 },
                { temp: 22, minTemp: 14, weather: 'Clear', description: 'sonƒçno', rain: 0 },
                { temp: 19, minTemp: 15, weather: 'Clear', description: 'lepo', rain: 0 }
            ];
            displayWeather();
        }

        function displayWeather() {
            for (let i = 0; i < 5 && i < realWeatherData.length; i++) {
                const weather = realWeatherData[i];
                const icon = weatherIcons[weather.weather] || 'üå§Ô∏è';
                const cell = document.getElementById(`weather-${i}`);

                cell.innerHTML = `
                    <span class="weather-icon">${icon}</span>
                    <span class="weather-temp">${weather.temp}¬∞</span>
                    <span class="weather-desc">${weather.description}</span>
                    ${weather.rain > 0 ? `<br><span style="color: #2196f3; font-size: 0.9em;">Padavine: ${weather.rain.toFixed(1)}mm</span>` : ''}
                `;
            }
        }

        function setDemoShortages() {
            // Set some demo shortages to show varied reasons
            document.getElementById('shortage-last-1').checked = true;
            markShortage('last', 1);

            document.getElementById('shortage-last-3').checked = true;
            markShortage('last', 3);
        }

        function changeProduct() {
            currentProduct = document.getElementById('productSelect').value;

            // Update displays
            document.getElementById('currentProductDisplay').textContent =
                `${productEmojis[currentProduct]} ${currentProduct}`;
            document.getElementById('chartProductName').textContent = currentProduct;

            // Reset data
            lastYearShortageMap = {};
            currentYearShortageMap = {};
            aiPrognosis = [];
            actualSales = [];

            // Clear checkboxes and inputs
            for (let i = 0; i < 5; i++) {
                document.getElementById(`shortage-last-${i}`).checked = false;
                document.getElementById(`shortage-current-${i}`).checked = false;
                document.getElementById(`actual-${i}`).value = '';
            }

            // Hide AI sections
            document.getElementById('ai-header').style.display = 'none';
            document.getElementById('ai-reasons').style.display = 'none';

            updateDisplay();
        }

        function updateDisplay() {
            const data = historicalData[currentProduct];
            let total = 0;

            // Update historical data cells
            for (let i = 0; i < 5; i++) {
                const cell = document.getElementById(`hist-${i}`);
                const value = data[i];
                total += value;

                let html = `${value}<br>`;
                html += `<input type="checkbox" class="shortage-checkbox" id="shortage-last-${i}" onchange="markShortage('last', ${i})">`;
                html += `<label class="shortage-label">pomanjkanje</label>`;

                cell.innerHTML = html;
            }

            document.getElementById('hist-total').textContent = total;
            document.getElementById('actual-total').textContent = '-';

            updateChart();
        }

        function markShortage(type, dayIndex) {
            const checkbox = document.getElementById(`shortage-${type}-${dayIndex}`);
            const key = `${currentProduct}-${dayIndex}`;
            const map = type === 'last' ? lastYearShortageMap : currentYearShortageMap;

            if (checkbox.checked) {
                map[key] = true;

                // Show alternative data source for last year shortage
                if (type === 'last') {
                    const cell = document.getElementById(`hist-${dayIndex}`);
                    const originalValue = historicalData[currentProduct][dayIndex];
                    const altValue = alternativeData[currentProduct][dayNames[dayIndex]];

                    cell.innerHTML = `
                        <s style="color: #999;">${originalValue}</s> ‚Üí ${altValue}<br>
                        <input type="checkbox" class="shortage-checkbox" id="shortage-last-${dayIndex}"
                               onchange="markShortage('last', ${dayIndex})" checked>
                        <label class="shortage-label">pomanjkanje</label>
                        <div class="alternative-data">
                            üìä Podatki: ${dayNames[dayIndex]}
                        </div>
                    `;
                }
            } else {
                delete map[key];

                // Reset display for last year
                if (type === 'last') {
                    updateDisplay();
                }
            }

            // Recalculate AI prognosis if it was already generated
            if (aiPrognosis.length > 0) {
                generateAIPrognosis();
            }
        }

        function generateAIPrognosis() {
            // Show AI sections
            document.getElementById('ai-header').style.display = 'table-row';
            document.getElementById('ai-reasons').style.display = 'table-row';

            // Reset
            aiPrognosis = [];
            let total = 0;

            // Calculate for each weekday
            for (let day = 0; day < 5; day++) {
                const key = `${currentProduct}-${day}`;
                let value = historicalData[currentProduct][day];
                let reasons = [];

                // Use alternative data if last year had shortage
                let usingAltData = false;
                if (lastYearShortageMap[key]) {
                    value = alternativeData[currentProduct][dayNames[day]];
                    usingAltData = true;
                    reasons.push('Alt. podatki ‚û°');
                }

                // Weather adjustments - affects all products and days
                if (realWeatherData[day]) {
                    const weather = realWeatherData[day];

                    // Rain impact - reduces sales up to 15%
                    if (weather.rain > 5) {
                        value *= 0.85; // -15%
                        reasons.push('Moƒçan de≈æ ‚Üì‚Üì');
                    } else if (weather.rain > 2) {
                        value *= 0.90; // -10%
                        reasons.push('De≈æ ‚Üì');
                    } else if (weather.rain > 0) {
                        value *= 0.95; // -5%
                        reasons.push('Rahel de≈æ ‚Üì');
                    }
                    // Sunny/clear weather - increases sales up to 15%
                    else if (weather.weather === 'Clear' && weather.temp > 20) {
                        value *= 1.15; // +15%
                        reasons.push('Sonƒçno ‚Üë‚Üë');
                    } else if (weather.weather === 'Clear' && weather.temp > 15) {
                        value *= 1.10; // +10%
                        reasons.push('Lepo vreme ‚Üë');
                    } else if (weather.weather === 'Clear') {
                        value *= 1.05; // +5%
                        reasons.push('Jasno ‚Üë');
                    }
                    // Cloudy weather - neutral to slight decrease
                    else if (weather.weather === 'Clouds') {
                        value *= 0.98; // -2%
                        reasons.push('Oblaƒçno ‚Üì');
                    }

                    // Extreme weather conditions
                    if (weather.weather === 'Thunderstorm') {
                        value *= 0.85; // -15%
                        reasons.push('Nevihta ‚Üì‚Üì');
                    } else if (weather.weather === 'Snow') {
                        value *= 0.85; // -15%
                        reasons.push('Sneg ‚Üì‚Üì');
                    }
                }

                // Holiday effects (mock - in real system would check actual calendar)
                if (day === 2) { // Wednesday - simulate day before holiday
                    if (currentProduct === 'Ra≈ænjiƒçi' || currentProduct === 'Krila') {
                        value *= 1.12;
                        reasons.push('Pred praznikom ‚Üë');
                    }
                } else if (day === 4) { // Friday
                    if (currentProduct === 'Ra≈ænjiƒçi') {
                        value *= 1.15;
                        reasons.push('Praznik ‚Üë‚Üë');
                    } else if (currentProduct === 'File prsi') {
                        value *= 1.08;
                        reasons.push('Praznik ‚Üë');
                    }
                }

                value = Math.round(value);
                aiPrognosis.push(value);
                total += value;

                // Display value with change
                const cell = document.getElementById(`ai-${day}`);
                const baseValue = lastYearShortageMap[key]
                    ? alternativeData[currentProduct][dayNames[day]]
                    : historicalData[currentProduct][day];
                const change = ((value - baseValue) / baseValue * 100).toFixed(0);

                let displayHtml = `${value}`;
                if (Math.abs(change) > 5) {
                    displayHtml += `<br><span class="${change > 0 ? 'increase' : 'decrease'}">(${change > 0 ? '+' : ''}${change}%)</span>`;
                }
                if (usingAltData) {
                    displayHtml += `<br><span style="font-size: 0.75em; color: #666;">[alt]</span>`;
                }
                cell.innerHTML = displayHtml;

                // Display reasons
                const reasonCell = document.getElementById(`reason-${day}`);
                if (reasons.length > 0) {
                    reasonCell.innerHTML = reasons.map(r => {
                        let className = 'reason-neutral';
                        if (r.includes('‚Üë')) className = 'reason-up';
                        else if (r.includes('‚Üì')) className = 'reason-down';
                        return `<span class="reason-badge ${className}">${r}</span>`;
                    }).join(' ');
                } else {
                    reasonCell.innerHTML = '<span style="color: green; font-weight: bold;">‚úì</span>';
                }
            }

            document.getElementById('ai-total').textContent = total;
            updateChart();
        }

        function updateActuals() {
            actualSales = [];
            let total = 0;

            for (let day = 0; day < 5; day++) {
                const input = document.getElementById(`actual-${day}`);
                const value = parseInt(input.value) || 0;
                actualSales.push(value);
                total += value;
            }

            document.getElementById('actual-total').textContent = total || '-';
            updateChart();
        }

        function initializeChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ponedeljek', 'Torek', 'Sreda', 'ƒåetrtek', 'Petek'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Koliƒçina (kg)',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            const datasets = [];

            // Historical data
            datasets.push({
                label: 'Lani',
                data: historicalData[currentProduct],
                borderColor: '#9e9e9e',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4
            });

            // AI prognosis
            if (aiPrognosis.length > 0) {
                datasets.push({
                    label: 'AI Prognoza',
                    data: aiPrognosis,
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderWidth: 3,
                    tension: 0.4
                });
            }

            // Actual sales
            if (actualSales.some(v => v > 0)) {
                datasets.push({
                    label: 'Dejanska',
                    data: actualSales,
                    borderColor: '#4caf50',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointStyle: 'rect',
                    pointRadius: 8,
                    tension: 0.4
                });
            }

            chart.data.datasets = datasets;
            chart.update();
        }
    </script>
</body>
</html>